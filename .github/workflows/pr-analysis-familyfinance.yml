name: –ê–Ω–∞–ª–∏–∑ Pull Request (–ú–∞–π 2025)

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  metadata-collection:
    name: –°–±–æ—Ä –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö PR
    runs-on: ubuntu-latest
    outputs:
      pr_number: ${{ steps.metadata.outputs.pr_number }}
      branch_name: ${{ steps.metadata.outputs.branch_name }}
      file_count: ${{ steps.metadata.outputs.file_count }}
      diff_size: ${{ steps.metadata.outputs.diff_size }}
    steps:
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö PR
        id: metadata
        uses: actions/github-script@v7
        with:
          script: |
            const prData = context.payload.pull_request;
            const prNumber = prData ? prData.number : null;
            const branchName = prData ? prData.head.ref : null;
            
            if (!prNumber && !context.payload.workflow_dispatch) {
              core.setFailed('–≠—Ç–æ—Ç workflow –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ PR –∏–ª–∏ –≤—Ä—É—á–Ω—É—é');
              return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä PR –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
            let number = prNumber;
            if (!number && context.payload.workflow_dispatch) {
              const issuePayload = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                sort: 'updated',
                direction: 'desc'
              });
              
              const prs = issuePayload.data.filter(issue => issue.pull_request);
              if (prs.length > 0) {
                number = prs[0].number;
              } else {
                core.setFailed('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö PR');
                return;
              }
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ PR —á–µ—Ä–µ–∑ GraphQL API
            const { repository } = await github.graphql(`
              query ($owner: String!, $name: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $name) {
                  pullRequest(number: $prNumber) {
                    title
                    files(first: 100) {
                      totalCount
                      nodes {
                        path
                        additions
                        deletions
                        changeType
                      }
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              name: context.repo.repo,
              prNumber: number
            });
            
            const prFiles = repository.pullRequest.files;
            const fileCount = prFiles.totalCount;
            const diffSize = prFiles.nodes.reduce((acc, file) => acc + file.additions + file.deletions, 0);
            
            core.setOutput('pr_number', number);
            core.setOutput('branch_name', branchName || 'unknown');
            core.setOutput('file_count', fileCount);
            core.setOutput('diff_size', diffSize);
  code-analysis:
    name: –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ Python
    needs: metadata-collection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          python -m pip install --upgrade pip
          if [ -f app/requirements.txt ]; then
            pip install -r app/requirements.txt
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pylint flake8 mypy pytest bandit black radon lizard
      
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —á–µ—Ä–µ–∑ API
        id: pr-diff
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.metadata-collection.outputs.pr_number }};
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º GraphQL API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ PR
            const { repository } = await github.graphql(`
              query ($owner: String!, $name: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $name) {
                  pullRequest(number: $prNumber) {
                    files(first: 100) {
                      nodes {
                        path
                        additions
                        deletions
                        patch
                      }
                    }
                    commits(last: 1) {
                      nodes {
                        commit {
                          oid
                        }
                      }
                    }
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              name: context.repo.repo,
              prNumber: parseInt(prNumber)
            });
            
            // –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
            const files = repository.pullRequest.files.nodes;
            const commitSha = repository.pullRequest.commits.nodes[0]?.commit.oid;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            const fs = require('fs');
            fs.writeFileSync('pr_files.json', JSON.stringify(files, null, 2));
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            const pythonFiles = files.filter(f => f.path.endsWith('.py'));
            const testFiles = files.filter(f => f.path.includes('test_'));
            const schemaFiles = files.filter(f => f.path.includes('schemas/') || f.path.includes('models/'));
            
            return {
              filesCount: files.length,
              pythonFilesCount: pythonFiles.length,
              testFilesCount: testFiles.length,
              schemaFilesCount: schemaFiles.length,
              commitSha
            };
        - name: –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ Python
        id: code-analysis
        continue-on-error: true
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞
          python -c "
import json
import os

try:
    with open('pr_files.json', 'r') as f:
        files = json.load(f)
    
    py_files = [file['path'] for file in files if file['path'].endswith('.py')]
    
    with open('firecrawl_analysis.md', 'w') as out:
        out.write('# –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ\\n\\n')
        
        # –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        out.write(f'## –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\\n\\n')
        out.write(f'- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ Python: {len(py_files)}\\n')
        out.write(f'- –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤: {len(files)}\\n\\n')
        
        # –ê–Ω–∞–ª–∏–∑ Python-—Ñ–∞–π–ª–æ–≤
        if py_files:
            out.write('## –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–æ–≤ Python\\n\\n')
            
            for py_file in py_files:
                if os.path.exists(py_file):
                    out.write(f'### –§–∞–π–ª: {py_file}\\n\\n')
                    
                    # –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
                    out.write('#### –ê–Ω–∞–ª–∏–∑ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞\\n\\n')
                    os.system(f'lizard {py_file} > lizard_out.txt 2>&1')
                    with open('lizard_out.txt', 'r') as lizard_out:
                        out.write('```\\n' + lizard_out.read() + '\\n```\\n\\n')
                    
                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è
                    out.write('#### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞\\n\\n')
                    os.system(f'flake8 {py_file} > flake8_out.txt 2>&1 || true')
                    with open('flake8_out.txt', 'r') as flake8_out:
                        content = flake8_out.read()
                        if content.strip():
                            out.write('```\\n' + content + '\\n```\\n\\n')
                        else:
                            out.write('–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º —Å–æ —Å—Ç–∏–ª–µ–º –∫–æ–¥–∞.\\n\\n')
        else:
            out.write('–ù–µ –Ω–∞–π–¥–µ–Ω–æ Python-—Ñ–∞–π–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.\\n\\n')
            
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ Sequential Thinking
        out.write('## –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞\\n\\n')
        out.write('1. **–ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:** –û—Ü–µ–Ω–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤\\n')
        out.write('2. **–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π –ø–∞–∫–µ—Ç–æ–≤\\n')
        out.write('3. **–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–æ—Ç–æ–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö\\n')
        out.write('4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π:** –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π\\n')
        out.write('5. **–û—Ü–µ–Ω–∫–∞ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** –û—Ü–µ–Ω–∫–∞ –≤–ª–∏—è–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∏—Å—Ç–µ–º—ã\\n')
except Exception as e:
    print(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: {e}')
    with open('firecrawl_analysis.md', 'w') as out:
        out.write(f'# –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞\\n\\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: {e}\\n')
"
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –º–æ–¥–µ–ª—è—Ö –¥–∞–Ω–Ω—ã—Ö
          if grep -q "schemas\|models" pr_files.json; then
            echo "–ê–Ω–∞–ª–∏–∑ –º–æ–¥–µ–ª–µ–π –¥–∞–Ω–Ω—ã—Ö (Pydantic)..."
            python -c "
import json
import os
import re

try:
    with open('pr_files.json', 'r') as f:
        files = json.load(f)
    
    model_files = [file['path'] for file in files 
                   if ('schemas' in file['path'] or 'models' in file['path']) and file['path'].endswith('.py')]
    
    with open('pydantic_analysis.md', 'w') as out:
        out.write('# –ê–Ω–∞–ª–∏–∑ Pydantic-–º–æ–¥–µ–ª–µ–π\\n\\n')
        
        if model_files:
            for model_file in model_files:
                if os.path.exists(model_file):
                    out.write(f'## –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: {model_file}\\n\\n')
                    
                    with open(model_file, 'r') as src:
                        content = src.read()
                        
                        # –ü–æ–∏—Å–∫ –∫–ª–∞—Å—Å–æ–≤ Pydantic
                        class_matches = re.findall(r'class\\s+([\\w]+)\\s*\\(\\s*(?:BaseModel|Schema)\\s*\\)', content)
                        
                        if class_matches:
                            out.write('### –ù–∞–π–¥–µ–Ω–Ω—ã–µ Pydantic-–º–æ–¥–µ–ª–∏:\\n\\n')
                            for cls in class_matches:
                                out.write(f'- `{cls}`\\n')
                            out.write('\\n')
                            
                            out.write('#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ Pydantic-–º–æ–¥–µ–ª—è–º:\\n\\n')
                            out.write('- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö\\n')
                            out.write('- –î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª–µ–π —á–µ—Ä–µ–∑ Field —Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º–∏\\n')
                            out.write('- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Config –∫–ª–∞—Å—Å–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–µ–π\\n\\n')
                        else:
                            out.write('–ù–µ –Ω–∞–π–¥–µ–Ω—ã Pydantic-–º–æ–¥–µ–ª–∏ –≤ —Ñ–∞–π–ª–µ.\\n\\n')
        else:
            out.write('–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å Pydantic-–º–æ–¥–µ–ª—è–º–∏.\\n')
except Exception as e:
    print(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ Pydantic-–º–æ–¥–µ–ª–µ–π: {e}')
    with open('pydantic_analysis.md', 'w') as out:
        out.write(f'# –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞\\n\\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ Pydantic-–º–æ–¥–µ–ª–µ–π: {e}\\n')
"
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ API
          if grep -q "api\|router" pr_files.json; then
            echo "–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π API..."
            python -c "
import json
import os
import re

try:
    with open('pr_files.json', 'r') as f:
        files = json.load(f)
    
    api_files = [file['path'] for file in files 
                if ('api' in file['path'] or 'router' in file['path']) and file['path'].endswith('.py')]
    
    with open('api_analysis.md', 'w') as out:
        out.write('# –ê–Ω–∞–ª–∏–∑ API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤\\n\\n')
        
        if api_files:
            for api_file in api_files:
                if os.path.exists(api_file):
                    out.write(f'## –ê–Ω–∞–ª–∏–∑ —Ñ–∞–π–ª–∞: {api_file}\\n\\n')
                    
                    with open(api_file, 'r') as src:
                        content = src.read()
                        
                        # –ü–æ–∏—Å–∫ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤
                        endpoint_matches = re.findall(r'@(?:[\\w\\.]+\\.)?(?:get|post|put|delete|patch)\\([\"\\']([^\"\\']*)[\"\\\']', content)
                        
                        if endpoint_matches:
                            out.write('### –ù–∞–π–¥–µ–Ω–Ω—ã–µ API-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã:\\n\\n')
                            for endpoint in endpoint_matches:
                                out.write(f'- `{endpoint}`\\n')
                            out.write('\\n')
                            
                            out.write('#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ API:\\n\\n')
                            out.write('- –î–æ–±–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞\\n')
                            out.write('- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤\\n')
                            out.write('- –û–±–µ—Å–ø–µ—á—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–¥–æ–≤ —Å—Ç–∞—Ç—É—Å–∞\\n\\n')
                        else:
                            out.write('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤ –≤ —Ñ–∞–π–ª–µ.\\n\\n')
        else:
            out.write('–ù–µ –Ω–∞–π–¥–µ–Ω—ã —Ñ–∞–π–ª—ã —Å API-—ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º–∏.\\n')
except Exception as e:
    print(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ API: {e}')
    with open('api_analysis.md', 'w') as out:
        out.write(f'# –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞\\n\\n–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ API: {e}\\n')
"
          fi
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          mkdir -p reports
      
      - name: –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ FastAPI
        id: generate-fastapi-report
        run: |
          echo "## üíª –û—Ç—á–µ—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è" > fastapi_report.md
          echo "" >> fastapi_report.md
          echo "### üîç –°—Ç—Ä—É–∫—Ç—É—Ä–∞ API" >> fastapi_report.md
          echo "" >> fastapi_report.md
          
          # –ê–Ω–∞–ª–∏–∑ —Ä–æ—É—Ç–µ—Ä–æ–≤
          files=$(find app -type f -name "*.py" -exec grep -l "APIRouter" {} \;)
          if [ -n "$files" ]; then
            echo "–ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ API —Ä–æ—É—Ç–µ—Ä—ã:" >> fastapi_report.md
            echo "" >> fastapi_report.md
            echo "| –ú–æ–¥—É–ª—å | –ü—Ä–µ—Ñ–∏–∫—Å | –¢–µ–≥–∏ |" >> fastapi_report.md
            echo "|--------|---------|------|" >> fastapi_report.md
            
            for file in $files; do
              prefix=$(grep -o 'prefix="[^"]*"' "$file" || grep -o "prefix='[^']*'" "$file")
              tags=$(grep -o 'tags=\[[^\]]*\]' "$file")
              module=$(basename "$file" .py)
              echo "| $module | $prefix | $tags |" >> fastapi_report.md
            done
            echo "" >> fastapi_report.md
          fi
          
          # –ê–Ω–∞–ª–∏–∑ —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
          echo "### üìä –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö" >> fastapi_report.md
          echo "" >> fastapi_report.md
          
          pydantic_files=$(find app -type f -name "*.py" -exec grep -l "BaseModel" {} \;)
          if [ -n "$pydantic_files" ]; then
            echo "–ù–∞–π–¥–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –º–æ–¥–µ–ª–∏ Pydantic:" >> fastapi_report.md
            echo "" >> fastapi_report.md
            for file in $pydantic_files; do
              models=$(grep -E "class [a-zA-Z_]+ *\([^)]*BaseModel[^)]*\)" "$file" | sed -E 's/class ([a-zA-Z_]+).*/\1/g')
              if [ -n "$models" ]; then
                echo "**–§–∞–π–ª:** \`$file\`" >> fastapi_report.md
                echo "" >> fastapi_report.md
                echo '```' >> fastapi_report.md
                echo "$models" >> fastapi_report.md
                echo '```' >> fastapi_report.md
                echo "" >> fastapi_report.md
              fi
            done
          fi

      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞
        id: final-report
        run: |
          # –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ—Ç—á–µ—Ç–∞
          echo "# üîç –û—Ç—á–µ—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É Pull Request" > review.md
          echo "" >> review.md
          echo "## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π" >> review.md
          echo "- **–í–µ—Ç–∫–∞:** \`${{ needs.metadata-collection.outputs.branch_name }}\`" >> review.md
          echo "- **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:** ${{ needs.metadata-collection.outputs.file_count }}" >> review.md
          echo "- **–í—Å–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** ${{ needs.metadata-collection.outputs.diff_size }} (–¥–æ–±–∞–≤–ª–µ–Ω–æ + —É–¥–∞–ª–µ–Ω–æ)" >> review.md
          echo "" >> review.md
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -f "firecrawl_analysis.md" ]; then
            echo "## üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞" >> review.md
            echo "" >> review.md
            cat firecrawl_analysis.md >> review.md
            echo "" >> review.md
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –∞–Ω–∞–ª–∏–∑–∞ –º–æ–¥–µ–ª–µ–π Pydantic, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -f "pydantic_analysis.md" ]; then
            echo "## üìù –ê–Ω–∞–ª–∏–∑ Pydantic –º–æ–¥–µ–ª–µ–π" >> review.md
            echo "" >> review.md
            cat pydantic_analysis.md >> review.md
            echo "" >> review.md
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –æ–± API, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
          if [ -f "api_analysis.md" ]; then
            echo "## üåê –ê–Ω–∞–ª–∏–∑ API" >> review.md
            echo "" >> review.md
            cat api_analysis.md >> review.md
            echo "" >> review.md
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—á–µ—Ç –ø–æ FastAPI
          if [ -f "fastapi_report.md" ]; then
            cat fastapi_report.md >> review.md
            echo "" >> review.md
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ Sequential Thinking
          echo "## üß© –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞" >> review.md
          echo "" >> review.md
          echo "1. **–ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞:** –û—Ü–µ–Ω–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞ –∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤" >> review.md
          echo "2. **–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –≤–µ—Ä—Å–∏–π –ø–∞–∫–µ—Ç–æ–≤" >> review.md
          echo "3. **–ê–Ω–∞–ª–∏–∑ –ª–æ–≥–∏–∫–∏:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–æ—Ç–æ–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö" >> review.md
          echo "4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤:** –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π" >> review.md
          echo "5. **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é:** –û—Ü–µ–Ω–∫–∞ –≤–ª–∏—è–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–∏—Å—Ç–µ–º—ã" >> review.md
          echo "" >> review.md
          
          echo "## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏" >> review.md
          echo "" >> review.md
          echo "–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:" >> review.md
          
          # Python-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          if grep -q "\.py" pr_files.json; then
            echo "- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ –∫–æ–¥–∞ Python —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É PEP 8" >> review.md
            echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö" >> review.md
            echo "- –î–æ–±–∞–≤—å—Ç–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –∫–æ–¥–∞" >> review.md
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–µ—Å—Ç–∞—Ö
            if grep -q "test_" pr_files.json; then
              echo "- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø–æ–ª–Ω–æ—Ç–µ –ø–æ–∫—Ä—ã—Ç–∏—è —Ç–µ—Å—Ç–∞–º–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏" >> review.md
            else
              echo "- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏" >> review.md
            fi
          fi
          
          # MongoDB-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          if grep -q "mongodb\|coll\|collection" pr_files.json; then
            echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã MongoDB –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤" >> review.md
            echo "- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö –ø–∞–π–ø–ª–∞–π–Ω–æ–≤" >> review.md
            echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –∫—É—Ä—Å–æ—Ä–æ–≤ –¥–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–∞–Ω–Ω—ã—Ö" >> review.md
          fi
          
          # FastAPI-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          if grep -q "router\|APIRouter" pr_files.json; then
            echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö" >> review.md
            echo "- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π —Ç–∏–ø–æ–≤ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ OpenAPI" >> review.md
            echo "- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º HTTPException" >> review.md
          fi
          
          echo "" >> review.md
          
          # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å copilot_reviev_settings.txt
          echo "–° –ø—Ä–∞–≤–∏–ª–∞–º–∏ –æ–∑–Ω–∞–∫–æ–º–∏–ª—Å—è $(date +%d.%m.%Y)" >> review.md
      
      - name: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –≤ PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('review.md', 'utf8');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç –±–æ—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.metadata-collection.outputs.pr_number }}
            });
            
            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('–û—Ç—á–µ—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É Pull Request')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: reviewContent
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ needs.metadata-collection.outputs.pr_number }},
                body: reviewContent
              });
            }
