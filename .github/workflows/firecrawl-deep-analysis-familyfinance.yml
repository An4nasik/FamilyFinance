name: –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å Firecrawl MCP

on:
  workflow_run:
    workflows: ["–ê–Ω–∞–ª–∏–∑ Pull Request (–ú–∞–π 2025)"]
    types: [completed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: '–ù–æ–º–µ—Ä PR –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  firecrawl-deep-analysis:
    name: –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å Firecrawl MCP
    runs-on: ubuntu-latest
    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö PR
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–æ–º–µ—Ä PR –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å–æ–±—ã—Ç–∏—è –∏–ª–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            let prNumber;
            if (context.payload.workflow_run) {
              // –ó–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ workflow_run
              const run = context.payload.workflow_run;
              const prInfo = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: run.head_sha
              });
              
              if (prInfo.data.length > 0) {
                prNumber = prInfo.data[0].number;
              } else {
                core.setFailed('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–π PR');
                return;
              }
            } else {
              // –ó–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ workflow_dispatch
              prNumber = context.payload.inputs.pr_number;
            }
            
            core.setOutput('pr_number', prNumber);
            return { prNumber };
      
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Firecrawl MCP
        run: |
          python -m pip install --upgrade pip
          pip install firecrawl-mcp==3.2.0
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞
          if [ -f app/requirements.txt ]; then
            pip install -r app/requirements.txt
          elif [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π PR
        id: get-changes
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.pr-details.outputs.pr_number }};
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è PR –∏—Å–ø–æ–ª—å–∑—É—è GraphQL –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            const { repository } = await github.graphql(`
              query ($owner: String!, $name: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $name) {
                  pullRequest(number: $prNumber) {
                    files(first: 100) {
                      nodes {
                        path
                        additions
                        deletions
                        patch
                      }
                    }
                    title
                    body
                    headRefOid
                    baseRefOid
                  }
                }
              }
            `, {
              owner: context.repo.owner,
              name: context.repo.repo,
              prNumber: parseInt(prNumber)
            });
            
            const prData = repository.pullRequest;
            const fs = require('fs');
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            fs.writeFileSync('pr_files.json', JSON.stringify(prData.files.nodes, null, 2));
            
            // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ PR
            const metadata = {
              title: prData.title,
              body: prData.body,
              number: prNumber,
              headCommit: prData.headRefOid,
              baseCommit: prData.baseRefOid
            };
            fs.writeFileSync('pr_metadata.json', JSON.stringify(metadata, null, 2));
            
            return {
              filesCount: prData.files.nodes.length,
              title: prData.title,
              headCommit: prData.headRefOid,
              baseCommit: prData.baseRefOid
            };
      
      - name: –ó–∞–ø—É—Å–∫ Firecrawl MCP —Å Sequential Thinking
        id: firecrawl-seq-thinking
        run: |
          # –í—ã–ø–æ–ª–Ω—è–µ–º –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –º—ã—à–ª–µ–Ω–∏–µ–º
          firecrawl-mcp analyze \
            --input-file "pr_files.json" \
            --metadata-file "pr_metadata.json" \
            --repository-path "$(pwd)" \
            --analysis-mode deep \
            --sequential-thinking-steps 5 \
            --output-format markdown \
            --output-file "sequential_analysis.md" \
            --language python \
            --framework fastapi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª sequential_analysis.md –±—ã–ª —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω
          if [ ! -f "sequential_analysis.md" ]; then
            echo "–û—à–∏–±–∫–∞: sequential_analysis.md –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi
      
      - name: –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        id: contextual-analysis
        run: |
          # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
          firecrawl-mcp analyze-context \
            --input-file "pr_files.json" \
            --repository-path "$(pwd)" \
            --depth 3 \
            --include-dependencies \
            --output-format markdown \
            --output-file "context_analysis.md" \
            --language python
      
      - name: –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ FastAPI & MongoDB
        id: specialized-analysis
        run: |
          # –ê–Ω–∞–ª–∏–∑ FastAPI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
          if grep -q "router\|APIRouter" pr_files.json; then
            firecrawl-mcp analyze-fastapi \
              --input-file "pr_files.json" \
              --repository-path "$(pwd)" \
              --output-format markdown \
              --output-file "fastapi_analysis.md"
          fi
          
          # –ê–Ω–∞–ª–∏–∑ MongoDB –∑–∞–ø—Ä–æ—Å–æ–≤
          if grep -q "mongodb\|collection\|coll(" pr_files.json; then
            firecrawl-mcp analyze-mongodb \
              --input-file "pr_files.json" \
              --repository-path "$(pwd)" \
              --output-format markdown \
              --output-file "mongodb_analysis.md"
          fi
      
      - name: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
        id: generate-coherence
        run: |
          # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–∞ –æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏, –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—â–µ–≥–æ –ª–æ–≥–∏—á–µ—Å–∫—É—é –Ω–µ–ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ—Å—Ç—å
          firecrawl-mcp analyze-coherence \
            --input-file "pr_files.json" \
            --repository-path "$(pwd)" \
            --sequential-output "sequential_analysis.md" \
            --context-output "context_analysis.md" \
            --output-format markdown \
            --output-file "coherence_report.md"
      
      - name: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        id: create-report
        run: |
          # –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Ç—á–µ—Ç–æ–≤ –≤ –æ–¥–∏–Ω –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑
          cat > "deep_analysis.md" << EOL
          # üî¨ –û—Ç—á–µ—Ç –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å Firecrawl MCP
          
          ## üß† –ê–Ω–∞–ª–∏–∑ —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –º—ã—à–ª–µ–Ω–∏–µ–º (Sequential Thinking)
          
          $(cat sequential_analysis.md)
          
          ## üåê –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          
          $(cat context_analysis.md)
          
          ## üß© –û—Ü–µ–Ω–∫–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –∫–æ–¥–∞
          
          $(cat coherence_report.md)
          
          ## üìä –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑
          EOL
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ FastAPI, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
          if [ -f "fastapi_analysis.md" ]; then
            cat >> "deep_analysis.md" << EOL
          
          ### FastAPI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
          
          $(cat fastapi_analysis.md)
          EOL
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ MongoDB, –µ—Å–ª–∏ –æ–Ω–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
          if [ -f "mongodb_analysis.md" ]; then
            cat >> "deep_analysis.md" << EOL
          
          ### MongoDB –∑–∞–ø—Ä–æ—Å—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
          
          $(cat mongodb_analysis.md)
          EOL
          fi
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          cat >> "deep_analysis.md" << EOL
          
          ## üöÄ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
          
          –ù–∞ –æ—Å–Ω–æ–≤–µ –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞, –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–æ–≥–æ Firecrawl MCP —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Sequential Thinking:
          
          1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã:** $(grep -A 3 "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞\|Architecture" sequential_analysis.md | grep -v "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞\|Architecture" | head -n 1 || echo "–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º.")
          
          2. **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** $(grep -A 3 "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\|Performance" sequential_analysis.md | grep -v "–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å\|Performance" | head -n 1 || echo "–ù–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å.")
          
          3. **–û—Ü–µ–Ω–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏:** $(grep -A 2 "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å\|Maintainability" coherence_report.md | grep -v "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å\|Maintainability" | head -n 1 || echo "–ö–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏.")
          
          4. **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:** –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É, —É—á–∏—Ç—ã–≤–∞—è –º–æ–º–µ–Ω—Ç—ã, –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –≤ —ç—Ç–æ–º –∞–Ω–∞–ª–∏–∑–µ.
          
          –° –ø—Ä–∞–≤–∏–ª–∞–º–∏ –æ–∑–Ω–∞–∫–æ–º–∏–ª—Å—è $(date +%d.%m.%Y)
          EOL
      
      - name: –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∞–Ω–∞–ª–∏–∑–∞ –≤ PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const analysisContent = fs.readFileSync('deep_analysis.md', 'utf8');
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ—Ç—á–µ—Ç–∞ (GitHub –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ —Ä–∞–∑–º–µ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è)
            const maxSize = 65000;
            let finalReport = analysisContent;
            
            if (analysisContent.length > maxSize) {
              finalReport = analysisContent.substring(0, maxSize) + 
                "\n\n‚ö†Ô∏è *–≠—Ç–æ—Ç –æ—Ç—á–µ—Ç –±—ã–ª —Å–æ–∫—Ä–∞—â–µ–Ω –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π —Ä–∞–∑–º–µ—Ä–∞. –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ª–æ–≥–∞—Ö workflow.*";
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
            const header = `# üî¨ –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å Firecrawl MCP (${new Date().toISOString().split('T')[0]})`;
            finalReport = header + "\n\n" + finalReport;
            
            // –ü—É–±–ª–∏–∫—É–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.pr-details.outputs.pr_number }},
              body: finalReport
            });
